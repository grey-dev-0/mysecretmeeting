(function(n,e,t){e(document).ready(function(){window.rtc=new n({el:"#app",data:{config:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"}]},connections:{qr_code:null,my_connection:{websocket_id:null,connection:null,stream:null,error:null,candidates:[]}},channels:{},websocket:null},methods:{init:function(n){this.websocket=new WebSocket("wss://"+n+"/websocket");this.websocket.onopen=function(){rtc.websocket.send(JSON.stringify({action:"init",qr_code:initCode}))};this.websocket.onmessage=function(n){var e=JSON.parse(n.data);switch(e.action){case"init":rtc.connections.qr_code=e.qr_code;rtc.connections.my_connection.websocket_id=e.id;rtc.connect(e.id);rtc.call(e.peers);new t("#copy-url");break;case"sdp":if(rtc.connections[e.id]===undefined)rtc.connect(e.id);rtc.exchangeSdps(e.id,e.sdp);break;case"candidate":if(e.candidate!=""&&e.candidate!=null){if(!rtc.connections[e.id].connection.remoteDescription)rtc.connections[e.id].candidates.push(e.candidate);else rtc.connections[e.id].connection.addIceCandidate(new RTCIceCandidate(e.candidate))}break}}},connect:function(e){var n;if(this.connections.my_connection.websocket_id==e){n=this.connections.my_connection.connection=new RTCPeerConnection(this.config);this.initLocalStream()}else{n=new RTCPeerConnection(this.config);this.connections[e]={connection:n,stream:null,error:null,candidates:[]};n.ontrack=function(n){console.log("stream track received",n);rtc.connections[e].stream=n.streams[0];rtc.$refs["video"+e][0].srcObject=n.streams[0]}}n.onicecandidate=function(n){rtc.websocket.send(JSON.stringify({action:"candidate",candidate:n.candidate}))}},initLocalStream:function(){var n=function(n){rtc.connections.my_connection.stream=n;setTimeout(function(){rtc.$refs.my_video[0].srcObject=n})};var e=function(n){rtc.connections.my_connection.error=n.message};var t={audio:true,video:true};switch(true){case navigator.getUserMedia!==undefined:navigator.getUserMedia(t,n,e);break;case navigator.webkitGetUserMedia!==undefined:navigator.webkitGetUserMedia(t,n,e);break;case navigator.mediaDevices!==undefined&&navigator.mediaDevices.getUserMedia!==undefined:navigator.mediaDevices.getUserMedia(t).then(n).catch(e);break;case navigator.mozGetUserMedia!==undefined:navigator.mozGetUserMedia(t,n,function(){});break;default:alert("Could NOT access Audio / Video Input!")}},call:function(e){for(var t in e){if(this.connections[e[t]]===undefined)this.connect(e[t]);this.connections[e[t]].connection.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true}).then(function(n){rtc.connections[e[t]].connection.setLocalDescription(n);rtc.websocket.send(JSON.stringify({action:"sdp",sdp:n}))})}},exchangeSdps:function(e,n){var t=this.connections.my_connection.websocket_id==e?this.connections.my_connection.connection:this.connections[e].connection;setTimeout(function(){if(n.type=="offer"){t.setRemoteDescription(new RTCSessionDescription(n));t.createAnswer().then(function(n){t.setLocalDescription(n);rtc.websocket.send(JSON.stringify({action:"sdp",sdp:n}));rtc.addCandidates(e)})}else{t.setRemoteDescription(new RTCSessionDescription(n)).then(function(){rtc.addCandidates(e)});rtc.connections.my_connection.stream.getTracks().forEach(function(n){t.addTrack(n,rtc.connections.my_connection.stream);console.log("streamed track of stream",rtc.connections.my_connection.stream)})}},1e3)},addCandidates:function(n){var e=this.connections[n].candidates;for(var t in e)this.connections[n].connection.addIceCandidate(e[t]);this.connections[n].candidates=[]}}});e("body").on("click","#upload-qr, #capture-qr",function(){e(this).next("input").trigger("click")})})})(Vue,jQuery,ClipboardJS);