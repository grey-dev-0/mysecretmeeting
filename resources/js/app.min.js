(function(o,i){o(document).ready(function(){window.rtc={config:{iceServers:[{url:"stun:stun.12connect.com:3478"},{url:"stun:stun.12voip.com:3478"},{url:"stun:stun.1und1.de:3478"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},peerCell:'<div class="col"><div class="card"><div class="card-body row"><video class="col d-none" autoplay></video><h3 class="d-none text-center w-100"></h3></div></div></div>',connections:{qr_code:null,my_connection:{websocket_id:null,connection:null,stream:null,error:null,candidates:[]}},channels:{},websocket:null,init:function(c){this.websocket=new WebSocket("wss://"+c+"/websocket");this.websocket.onopen=function(){rtc.websocket.send(JSON.stringify({action:"init",qr_code:initCode}))};this.websocket.onmessage=function(e){var n=JSON.parse(e.data);switch(n.action){case"init":rtc.connections.qr_code=n.qr_code;rtc.connections.my_connection.websocket_id=n.id;var t=o("#copy-url");o("#qr-code").attr("src","https://"+c+"/qr?c="+n.qr_code);t.attr("data-clipboard-text",t.attr("data-clipboard-text")+"?c="+n.qr_code);rtc.initLocalStream();rtc.call(n.peers);new i("#copy-url");break;case"sdp":if(rtc.connections[n.id]===undefined)rtc.connect(n.id);rtc.exchangeSdps(n.id,n.sdp);break;case"candidate":if(n.candidate!=""&&n.candidate!=null){if(!rtc.connections[n.id].connection.remoteDescription)rtc.connections[n.id].candidates.push(n.candidate);else rtc.connections[n.id].connection.addIceCandidate(new RTCIceCandidate(n.candidate))}break}}},connect:function(t){if(this.connections.my_connection.websocket_id!=t){var e=new RTCPeerConnection(this.config);this.connections[t]={connection:e,stream:null,error:null,candidates:[]};o("#app").append(o(this.peerCell).attr("id",t));n();e.ontrack=function(e){console.log("Received stream tracks",e.streams[0].getTracks(),"from connection",t);rtc.connections[t].stream=e.streams[0];var n=o("#"+t).find("video").removeClass("d-none")[0];if(n.srcObject==null){console.log("setting received stream.");n.srcObject=e.streams[0]}else{console.log("adding track to current stream");e.streams[0].getTracks().forEach(function(e){n.srcObject.addTrack(e)})}};e.onicecandidate=function(e){rtc.websocket.send(JSON.stringify({action:"candidate",candidate:e.candidate}))}}},initLocalStream:function(){var e=function(e){setTimeout(function(){rtc.connections.my_connection.stream=e;o("#my-connection").find("video").removeClass("d-none")[0].srcObject=e})};var n=function(e){rtc.connections.my_connection.error=e.message;o("#my-connection").find("h3").removeClass("d-none").text(e.message)};var t={audio:true,video:true};switch(true){case navigator.getUserMedia!==undefined:navigator.getUserMedia(t,e,n);break;case navigator.webkitGetUserMedia!==undefined:navigator.webkitGetUserMedia(t,e,n);break;case navigator.mediaDevices!==undefined&&navigator.mediaDevices.getUserMedia!==undefined:navigator.mediaDevices.getUserMedia(t).then(e).catch(n);break;case navigator.mozGetUserMedia!==undefined:navigator.mozGetUserMedia(t,e,function(){});break;default:alert("Could NOT access Audio / Video Input!")}},call:function(n){for(var t in n){if(this.connections[n[t]]===undefined)this.connect(n[t]);this.connections[n[t]].connection.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true}).then(function(e){rtc.connections[n[t]].connection.setLocalDescription(e);rtc.websocket.send(JSON.stringify({action:"sdp",sdp:e}))})}},exchangeSdps:function(n,e){var t=this.connections[n].connection;setTimeout(function(){if(e.type=="offer"){t.setRemoteDescription(new RTCSessionDescription(e));t.createAnswer({offerToReceiveAudio:true,offerToReceiveVideo:true}).then(function(e){t.setLocalDescription(e);rtc.websocket.send(JSON.stringify({action:"sdp",sdp:e}));rtc.addCandidates(n)})}else t.setRemoteDescription(new RTCSessionDescription(e)).then(function(){rtc.addCandidates(n)});t.onnegotiationneeded=function(){rtc.call([n])};rtc.connections.my_connection.stream.getTracks().forEach(function(e){console.log("Adding stream track",e,"to connection ",t);t.addTrack(e,rtc.connections.my_connection.stream)})},1e3)},addCandidates:function(e){var n=this.connections[e].candidates;for(var t in n)this.connections[e].connection.addIceCandidate(n[t]);this.connections[e].candidates=[]}};o("body").on("click","#capture-qr",function(){o(this).next("input").trigger("click")});o(window).on("load resize",n);function n(){var e=o("#app").children().not(".col-sm-6.col-md-3.col-lg-2");if(window.innerWidth<400)e.removeClass("col").addClass("col-12");else e.removeClass("col-12").addClass("col")}})})(jQuery,ClipboardJS);