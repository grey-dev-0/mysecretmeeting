(function(t,c){t(document).ready(function(){window.rtc={config:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},peerCell:'<div class="col"><div class="card"><div class="card-body row"><video class="col d-none" autoplay></video><h3 class="d-none text-center w-100"></h3></div></div></div>',connections:{qr_code:null,my_connection:{websocket_id:null,connection:null,stream:null,error:null,candidates:[]}},channels:{},websocket:null,init:function(e){this.websocket=new WebSocket("wss://"+e+"/websocket");this.websocket.onopen=function(){rtc.websocket.send(JSON.stringify({action:"init",qr_code:initCode}))};this.websocket.onmessage=function(e){var n=JSON.parse(e.data);switch(n.action){case"init":rtc.connections.qr_code=n.qr_code;rtc.connections.my_connection.websocket_id=n.id;rtc.connect(n.id);rtc.call(n.peers);new c("#copy-url");break;case"sdp":if(rtc.connections[n.id]===undefined)rtc.connect(n.id);rtc.exchangeSdps(n.id,n.sdp);break;case"candidate":if(n.candidate!=""&&n.candidate!=null){if(!rtc.connections[n.id].connection.remoteDescription)rtc.connections[n.id].candidates.push(n.candidate);else rtc.connections[n.id].connection.addIceCandidate(new RTCIceCandidate(n.candidate))}break}}},connect:function(n){if(this.connections.my_connection.websocket_id==n)this.initLocalStream();else{var e=new RTCPeerConnection(this.config);this.connections[n]={connection:e,stream:null,error:null,candidates:[]};t("#app").append(t(this.peerCell).attr("id",n));e.ontrack=function(e){console.log("Received stream",e.streams,"from connection",n);rtc.connections[n].stream=e.streams[0];rtc.$refs["video"+n][0].srcObject=e.streams[0]};e.onicecandidate=function(e){rtc.websocket.send(JSON.stringify({action:"candidate",candidate:e.candidate}))}}},initLocalStream:function(){var e=function(e){rtc.connections.my_connection.stream=e;setTimeout(function(){rtc.$refs.my_video[0].srcObject=e})};var n=function(e){rtc.connections.my_connection.error=e.message};var t={audio:true,video:true};switch(true){case navigator.getUserMedia!==undefined:navigator.getUserMedia(t,e,n);break;case navigator.webkitGetUserMedia!==undefined:navigator.webkitGetUserMedia(t,e,n);break;case navigator.mediaDevices!==undefined&&navigator.mediaDevices.getUserMedia!==undefined:navigator.mediaDevices.getUserMedia(t).then(e).catch(n);break;case navigator.mozGetUserMedia!==undefined:navigator.mozGetUserMedia(t,e,function(){});break;default:alert("Could NOT access Audio / Video Input!")}},call:function(n){for(var t in n){if(this.connections[n[t]]===undefined)this.connect(n[t]);this.connections[n[t]].connection.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true}).then(function(e){rtc.connections[n[t]].connection.setLocalDescription(e);rtc.websocket.send(JSON.stringify({action:"sdp",sdp:e}))})}},exchangeSdps:function(n,e){var t=this.connections[n].connection;setTimeout(function(){rtc.connections.my_connection.stream.getTracks().forEach(function(e){console.log("Adding stream track",e,"to connection",t);t.addTrack(e,rtc.connections.my_connection.stream)});if(e.type=="offer"){t.setRemoteDescription(new RTCSessionDescription(e));t.createAnswer().then(function(e){t.setLocalDescription(e);rtc.websocket.send(JSON.stringify({action:"sdp",sdp:e}));rtc.addCandidates(n)})}else t.setRemoteDescription(new RTCSessionDescription(e)).then(function(){rtc.addCandidates(n)})},1e3)},addCandidates:function(e){var n=this.connections[e].candidates;for(var t in n)this.connections[e].connection.addIceCandidate(n[t]);this.connections[e].candidates=[]}};t("body").on("click","#capture-qr",function(){t(this).next("input").trigger("click")})})})(jQuery,ClipboardJS);